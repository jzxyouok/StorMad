/**
 * 
 */				

$(function() {
	
	//初始化全局变量
	var pageNo=1;
	var bpName='';
	var year='';
	var month='';
	var repeatType='';
	var status='';
	
	//初始化数据
	list(pageNo,bpName,year,month,repeatType,status);
	
	//表达验证与提交
	layui.use('form', function(){
		var form = layui.form();
		form.render('select');
	
		//搜索表单提交
		form.on('submit(serach)', function(data){
			var val=data.field;
			var year=0;
			var month=0;

			//格式化时间
			if(val.date!='')
			{
				var date=val.date.split("-"); 
				year=date[0];
				month=date[1];						
			}
			
			list(1,val.bpName,year,month,val.repeatType,val.status)
			
		 	 return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
		});		
	});	
	
});

//关闭窗口
$("#back_list").on('click',function(){
	layer.closeAll('page');	
});


//获取列表
function list(pageNo,bpName,year,month,repeatType,status)
{
	//分页模块
	layui.use('laypage', function() {
		var laypage = layui.laypage,
			layer = layui.layer;
		
		var redata={pageNo:pageNo,pageSize:yonghui.pageSize,bpName:bpName,year:year,month:month,repeatType:repeatType,status:status};

		$.post(yonghui.contextPath + "/api/bidplan/query.jsp",redata,function(data){
				val=data.obj;
					  
				laypage({
					cont: 'pageNumber',
					groups: yonghui.groups,
					pages: val.pageCount,
					jump: function(obj, first){
						if(first) {
							get_info(val);
						} else {
							query(obj.curr,bpName,year,month,repeatType,status);
						}
					}
				});
		});			
	});
}


/*  分页查询数据*/
function get_info(data)
{	
	var val=data.record;

	var htm="";
	
	for(var i=0;i<val.length;i++)
	{
		//格式化投放时间
		if(val[i].startTime==0 && val[i].endTime==0)
		{
			var cTime="全时间段";	
		}
		else
		{
			var cTime=val[i].startTime+'点 至 '+val[i].endTime+'点';		
		}

		htm +='<tr>';
		
		htm +='<td>'+val[i].bpId+'</td><td>'+val[i].bpName+'</td><td>'+getLocalTime(val[i].createTime)+'</td><td>'+formatDate(val[i].startDate)+'至'+formatDate(val[i].endDate)+' '+cTime+'</td><td>'+val[i].repeatTypeCN+'</td>';

		htm +='<td>￥'+val[i].cbasePrice+'</td><td id="sc_status_'+val[i].bpId+'">'+val[i].statusCN+'</td>';
		
		htm +='<td><a class="active-status" href="#">启用</a> | <a href="#">停用</a> | <a href="creat-schedule.html">编辑</a></td>';

		htm +='</tr>';
	}
	
	$("#sechedule_list").html(htm);
}	

function query(pageNo,bpName,year,month,repeatType,status) {
	
	var redata={pageNo:pageNo,pageSize:yonghui.pageSize,bpName:bpName,year:year,month:month,repeatType:repeatType,status:status};

	$.post(yonghui.contextPath + "/api/bidplan/query.jsp",redata,function(data){
		if(data.errCode == 0) {
			get_info(data.obj);
		} else {
			layer.alert('查询列表失败!\r\n' + data.errMsg);
		}
	});
};

//格式化时间戳
function getLocalTime(nS) { 
	return new Date(parseInt(nS)).toLocaleString().replace(/年|月/g, "-").replace(/日/g, " ").replace(/下午/g, " ").replace(/上午/g, " "); 
} 
 
function formatDate(time) {
	  var date = new Date(time);
	  return [date.getFullYear(), date.getMonth() + 1, date.getDate()].join('-');
}