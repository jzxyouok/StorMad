/**
 * 
 */				

$(function() {

	//初始化
	$("#spec_img").hide();
	$("#spec_font").hide();
	$("#spec_qr_code").hide();

	//获取广告规格
	$.post(yonghui.contextPath + "/api/ad/getAllAdType.jsp",function(data){

		if(data.errCode==0)
		{
			var val=data.obj;

			if(val.length>0)
			{
				var htm='<select name="spec_type" id="spec_type" lay-filter="spec_type"  lay-verify="spec_type"><option value="">请选择规格类型</option>';
				
				for(var i=0;i<val.length;i++)
				{
					htm +='<option value="'+val[i].first+'">'+val[i].second+'</option>';
				}
				
				htm +='</select>';
			}
			
			
			$("#spec_type").html(htm);				
		}
		else
		{
			layer.alert(data.errMsg);
			return false	
		}
	})
	
	//表达验证与提交
	layui.use('form', function(){
		var form = layui.form();
		
		form.on('select(spec_type)', function(data){
			if(data.value==1)
			{
				$("#spec_img").show();
				$("#spec_font").hide();
				$("#spec_qr_code").hide();	
			}
			if(data.value==2)
			{
				$("#spec_font").show();
				$("#spec_img").hide();
				$("#spec_qr_code").hide();
			}
			if(data.value==3)
			{
				$("#spec_qr_code").show();
				$("#spec_img").hide();
				$("#spec_font").hide();
			}
		});
		
		form.verify({
			spec_name: function(value){
				if(value==""){
				return '请输入规格名称';
				}
			},
			spec_type: function(value){
				if(value==""){
				return '请选择规格类型';
				}
			},
			img_weight: function(value){
				if(value=="" && $("#spec_img").is(":visible")){
				return '请输入图片宽度';
				}
				if(isNaN(value) && $("#spec_img").is(":visible")){
				return '图片宽度必须为纯数字';
				}
			},
			img_height: function(value){
				if(value=="" && $("#spec_img").is(":visible")){
				return '请输入图片高度';
				}
				if(isNaN(value) && $("#spec_img").is(":visible")){
				return '图片高度必须为纯数字';
				}
			},
			max_font: function(value){
				if(value=="" && $("#spec_font").is(":visible")){
				return '请输入文字最大字符数';
				}
				if(isNaN(value) && $("#spec_font").is(":visible")){
				return '文字字符数必须为纯数字';
				}
			},
			qr_code: function(value){
				if(value=="" && $("#spec_qr_code").is(":visible")){
				return '请输入二维码最大字符数';
				}
				if(isNaN(value) && $("#spec_qr_code").is(":visible")){
				return '二维码字符数必须为纯数字';
				}
			}		
		});
		
		//提交表单
		form.on('submit(sub_spec)', function(data){
			var val=data.field;
			
			$.ajax({
				type : 'POST',
				url  : yonghui.contextPath + '/api/ad/adsize/addAdSize.jsp',
				data : {'asName':val.spec_name, 'adType':val.spec_type, 'width':val.img_weight, 'height':val.img_height},
				dataType : 'json',
				success : function(data) {
					console.log(data);
					if(data.errCode == 0) {
						layer.msg("添加成功");
						 location.reload();
					} else {
						layer.alert(data.errMsg);
					}
				},
				error : function(data) {
					layer.alert('添加异常');
				}
			});
			
			return false;
		});
	});

	//关闭窗口
	$("#back_list").on('click',function(){
		layer.closeAll('page');	
	});

			
	//分页模块
	layui.use('laypage', function() {
		var laypage = layui.laypage,
			layer = layui.layer;
	
	
		
		//初始化分页参数
		$.post(yonghui.contextPath + "/api/ad/adsize/findAdSizePage.jsp?pageSize="+yonghui.pageSize,function(data){
				pages=data.obj.pageCount;
					  
				laypage({
					cont: 'pageNumber',
					pages: pages,
					skin: '#2089ff',
					groups: 5,
					jump: function(obj, first){
					  if(!first){
						 get_info(obj.curr);
					  }
					  else
					  {
						 get_info(1); 
					  }
					}
				});
		});			
	});
		
});

//编辑广告规格
function edit_spec(id)
{
	var url=yonghui.contextPath + '/api/ad/adsize/updateAdSize.jsp';
	
	$.ajax({
				type : 'POST',
				url  : url,
				data : {'asName':val.spec_name, 'adType':val.spec_type, 'width':val.img_weight, 'height':val.img_height},
				dataType : 'json',
				success : function(data) {
					console.log(data);
					if(data.errCode == 0) {
						layer.msg("添加成功");
						 location.reload();
					} else {
						layer.alert(data.errMsg);
					}
				},
				error : function(data) {
					layer.alert('添加异常');
				}
			});	
}

//删除广告规格				
function del_spec(id)
{
	var url=yonghui.contextPath + '/api/ad/adsize/deleteAdSize.jsp';
	
	$.post(url,{asId:id},function(data){
		  if(data.errCode==0)
		  {
			if(data.obj==true)
			{
				layer.msg("删除成功");	
			} 
			else
			{
				layer.alert(data.errMsg);	
			}
		  }
		  else
		  {
			layer.alert(data.errMsg);  
		  }	
	});
}

//显示编辑窗口
function show_edit(id)
{
	layer.open({
		type: 1,
		area: ['680px', 'auto'],
		title: ['编辑规格', 'color:#666;font-size:14px;font-weight:bold;'], //自定义标题
		shadeClose: true, //点击遮罩关闭
		content: $('#addSpecification')
	});
	
	//获取广告规格信息
	var url=yonghui.contextPath + '/api/ad/adsize/getOneAdSize.jsp';
	
	$.post(url,{asId:id},function(data){
		  if(data.errCode==0)
		  {
				var info=data.obj;
				var adTypeobj=info.adType.split(","); 
				var adtype=adTypeobj[0];
				var adtypename=adTypeobj[1];

				$("#spec_name").val(info.asName);
  				$("#spec_type option[index='0']").remove();
				
				layui.use('form', function(){
					var form = layui.form();
					form.on('select(spec_type)', function(data){
						  alert(data.value); //得到被选中的值
					}); 
				})
				
				if(adtype==1)
				{
					$("#spec_img").show();
					$("#img_weight").val(info.width);
					$("#img_height").val(info.height);					
				}
				if(adtype==2)
				{
					$("#max_font").val(info.max_font);				
				}
				if(adtype==3)
				{
					$("#qr_code").val(info.qr_code);					
				}
		  }
		  else
		  {
				layer.alert(data.errMsg);  
		  }	
	})
}

/*  分页查询数据
* 	curr   当前页
*/
function get_info(curr)
{
	//请求url
	var url=yonghui.contextPath + "/api/ad/adsize/findAdSizePage.jsp?pageNo="+curr+"&pageSize="+yonghui.pageSize;
	
	//获取页码
	$.post(url,function(data){

		if(data.errCode==0)
		{
			var val=data.obj.record;
			
			if(val.length>0)
			{
				var htm="";
				for(var i=0;i<val.length;i++)
				{
					htm +='<tr>';
					
					var adTypeobj=val[i].adType.split(","); 
					var adtype=adTypeobj[0];
					var adtypename=adTypeobj[1];
					
					htm +='<td>'+val[i].asName+'</td><td>'+adtypename+'</td>';
						  
					if(adtype==1)
					{
					   htm +='<td>宽：'+val[i].width+'px&nbsp;高'+val[i].height+'px</td>';
					}
					htm +='<td>'+getLocalTime(val[i].createTime)+'</td><td>'+getLocalTime(val[i].optime)+'</td><td>'+val[i].operator+'</td><td><a class="specification-Edit" href="javascript:void(0)" onclick="show_edit('+val[i].asId+')" >编辑</a>&nbsp;|&nbsp;<a href="javascript:void(0)" onclick="del_spec('+val[i].asId+')" >删除</a></td>'
					htm +='</tr>';
				}
				
				$("#spec_info").html(htm);
			}
		}
		else
		{
			layer.alert(data.errMsg);
			return false	
		}
	});
}	

//格式化时间戳
function getLocalTime(nS) { 
	return new Date(parseInt(nS)).toLocaleString().replace(/年|月/g, "-").replace(/日/g, " ").replace(/下午/g, " "); 
} 