function API() {}
API.prototype = {
    /**
     * [API接口调用]
     * @param {[type]}   type [请求类型]
     * @param {[type]}   _url [url]
     * @param {[type]}   data [参数]
     * @param {Function} cb   [回调函数]
     */
    APImethod: function(type, url, data, cb) {
        $.ajax({
            type: type,
            url: yonghui.contextPath + url,
            dataType: 'json',
            data: data,
            success: cb
        });
    },
    post: function(url, data, cb) {
        return this.APImethod('POST', url, data, cb)
    },
    get: function(url, data, cb) {
        return this.APImethod('GET', url, data, cb)
    },
    simple: function(str, obj) {
        return str.replace(/\$\w+\$/gi, function(matchs) {
            var returns = obj[matchs.replace(/\$/g, "")];
            return typeof returns === "undefined" ? "" : returns;
        });
    }
};
var api = new API();

function Ader(options) {
    this.corpName = '';
    this.status = '';
    this.contact = '';
    this.phone = '';
    this.pageNo = 1;
    this.pageSize = yonghui.pageSize;
    this.num = 1;
    this.pageNumFlag = true;
    this.init();
}
Ader.prototype = {
	/**
	 * [广告主列表]
	 */
    getData: function() {
        var self = this;
        api.post('/api/ader/query.jsp', {
            op: 1,
            corpName: this.corpName,
            status: this.status,
            contact: this.contact,
            phone: this.phone,
            pageNo: this.pageNo,
            pageSize: this.pageSize
        }, function(res) {
            if (res.errCode === 0) {
                if (res.obj.record && res.obj.record.length) {
                    self.num = self.pageSize * (self.pageNo - 1) + 1;
                    if (res.obj.pageCount > 0 && self.pageNumFlag) {
                        self.pageNumFlag = false;
                        self.setPageNumber(res.obj.pageCount);
                    }
                    var aderList = '';
                    var aderItem = '<tr><td>$num$</td><td><a href="#">$corpName$</a></td><td>$state$</td><td>￥<span>$balance$</span>元</td><td>￥<span>$cashBalance$</span>元</td><td>￥<span>$goodsBalance$</span>元</td><td data-aduin="$adUin$" data-accountName="$accountname$"><a class="add-Cash" href="javascript:void(0);">添加金额</a>|<a href="javascript:void(0);" id="disable"$disableClass$>停用</a>|<a  href="javascript:void(0);" id="enable" $enableClass$>启用</a></td></tr>';
                    $.each(res.obj.record, function(n, item) {
                        aderList += api.simple(aderItem, {
                            num: self.num++,
                            corpName: item.corporation,
                            state: item.statusCN,
                            balance: item.balance,
                            cashBalance: item.cashBalance,
                            goodsBalance: item.goodsBalance,
                            adUin: item.adUin,
                            accountname: item.accountName,
                            disableClass: item.status !== 2 ? ' class="active-status"' : '',
                            enableClass: item.status !== 3 ? ' class="active-status"' : ''
                        })
                    });
                    $('#aderList').html(aderList);
                } else {
                    $('#aderList').html('');
                    self.setPageNumber(0);
                }
            }
        })
    },
    /**
     * [分页]
     * @param {[type]} pageCount [总页数]
     */
    setPageNumber: function(pageCount) {
        var self = this;
        layui.use('laypage', function() {
            var laypage = layui.laypage,
                layer = layui.layer;
            laypage({
                cont: 'pageNumber',
                pages: pageCount,
                skin: '#2089ff',
                skip: true,
                groups: yonghui.groups,
                jump: function(obj, first) {
                    //得到了当前页，用于向服务端请求对应数据
                    if (!first) {
                        self.pageNo = obj.curr;
                        self.getData();
                    }
                }
            });
        });
    },
    /**
     * [账户状态中文和数字对应]
     * @param {[type]} status [中文状态]
     */
    setStatus: function(status) {
        switch (status) {
            case '停用':
                return 3;
                break;
            case '正常':
                return 2;
                break;
            case '账户审核中':
                return 0;
                break;
            case '审核未通过':
                return 1;
                break;
            default:
                return '';
        }
    },
    /**
     * [停用账号]
     * @param  {[type]} adUin [广告主id]
     */
    disableAccount: function(adUin) {
        var self = this;
        api.post('/api/ader/freeze.jsp', {
            tuin: adUin,
            status: 3
        }, function(res) {
            if (res.errCode === 0) {
                layer.msg(res.obj.statusCN);
                self.getData();
            } else {
                layer.msg(res.obj.statusCN);
            }
        });
    },
    /**
     * [添加金额弹窗]
     */
    addCash: function() {
        layer.open({
            type: 1,
            area: ['auto', 'auto'],
            title: ['添加金额', 'color:#666;font-size:14px;font-weight:bold;'], //自定义标题
            shadeClose: true,
            content: $('#addCash')
        });
    },
    /**
     * [确认添加金额]
     * @param  {[type]} cash        [金额]
     * @param  {[type]} accountName [账户名]
     */
    confirmAddCash: function(cash, accountName) {
        layer.closeAll();
        layer.open({
            type: 1,
            area: ['auto', 'auto'],
            title: ['确认添加', 'color:#666;font-size:14px;font-weight:bold;'], //自定义标题
            shadeClose: true,
            content: '<div id="addCash-confirm" class="frame-content"><div class="frame-body add-cash"><p class="confirm"><span></span></p> <p>即将添加<span>' + cash + '元</span>至账户：<span>' + accountName + '</span></p><p>请确认款项是否成功对公转账，再次确认后将无法撤回操作，是否确认？</p><div class="layui-input-inline button-box"><button class="layui-btn" type="button" lay-submit="" lay-filter=" " id="btnConfirmAgain">确认</button></div></div></div>'
        });
    },
    /**
     * [添加金额]
     * @param {[type]} cash [金额]
     * @param {[type]} tuin [广告主id]
     * @param {[type]} type [添加金额类型(现金、货款)]
     */
    setCash: function(cash, tuin, type) {
        api.post('/api/money/recharge.jsp', {
            money: cash,
            tuin: tuin,
            type: 1
        }, function(res) {
            if (0 === res.errCode) {
                layer.msg('充值成功', {
                    time: 800
                });
            } else {
                layer.msg(res.errMsg, {
                    time: 800
                });
            }
            setTimeout(function() {
                location.reload();
            }, 1000);
        });
    },
    bindEvent: function() {
        var self = this;
        var accountName = '',
            cash = 0,
            addCashType = 0,
            aduin = null;
        $('#btnSearch').on('click', function() {
            self.corpName = document.getElementById('corpName').value;
            self.status = self.setStatus(document.getElementById('status').value);
            self.pageNo = 1;
            self.pageNumFlag = true;
            self.getData();
        });
        $('#aderList').on('click', '.add-Cash', function() {
            aduin = $(this).closest('td').data('aduin');
            accountName = $(this).closest('td').data('accountname');
            self.addCash();
        }).on('click', '#disable:not(.active-status)', function() {
            aduin = $(this).closest('td').data('aduin');
            self.disableAccount(aduin);
        });
        $('body').on('click', '#btnConfirm', function() {
            cash = $('#cash').val();
            var cashTypeVal = $('#addCash option:selected').val();
            if ('' === cashTypeVal) {
                layer.msg('请选择添加金额类型', {
                    time: 800
                });
            } else if ('' === $.trim(cash)) {
                layer.msg('请输入金额', {
                    time: 800
                });
            } else if (!/^(([1-9][0-9]*)|(([0]\.\d{1,2}|[1-9][0-9]*\.\d{1,2})))$/.test(cash)) {
                layer.msg('请输入正确的金额', {
                    time: 800
                });
            } else {
                self.confirmAddCash(cash, accountName);
                if ('现金' === cashTypeVal) {
                    addCashType = 1;
                } else if ('货款' === cashTypeVal) {
                    addCashType = 2;
                }
            }

        }).on('click', '#addCashReturn', function() {
            layer.closeAll();
        }).on('click', '#btnConfirmAgain', function() {
            self.setCash(cash, aduin, addCashType);
        });
    },
    init: function() {
        this.getData();
        this.bindEvent();
    }
}
$(function() {
    new Ader();
})
