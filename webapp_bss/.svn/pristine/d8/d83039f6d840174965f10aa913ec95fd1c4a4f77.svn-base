var form;
var laydate;

$(function() {
	
	//初始化数据模块
	get_industry();
	get_area();
	get_regional();
	
	//表达验证与提交
	layui.use('form', 'laydate', function(){
		form = layui.form();
		laydate = layui.laydate;
		
		//监听大区选择
		form.on('checkbox(check_region)', function(data){
		  	if(data.elem.checked && data.value==-1)
			{
				$('.regional_box').prop('checked',true);
				$("#shops_list_icon").hide();
				$("#shops_list").hide();
				$("#choice_shop_icon").hide();
				$("#div_choice_shop").hide();
			}
			if(!data.elem.checked && data.value==-1)
			{
				$('.regional_box').prop('checked',false);
			}
			if(data.elem.checked && data.value!=-1)
			{
				get_shops(data.value)	
			}
			form.render('checkbox');
		}); 

		//监听事件选择
		form.on('radio(choice_time)', function(data){
				if(data.value==1)
				{
					$("#div_choice_time").show();
					$("#startTime").attr('lay-verify','required');
					$("#endTime").attr('lay-verify','required');
				}
				else
				{
					$("#div_choice_time").hide();
					$("#startTime").removeAttr('lay-verify');
					$("#endTime").removeAttr('lay-verify');
				}
		}); 
		
		//提交新增表单
		form.on('submit(sub)', function(data){
			var val=data.field;
			var url=yonghui.contextPath + '/api/bidplan/create.jsp';
			
			//获取行业数组
			var iids=[];
			var iidsObj=$(".industry-type :input");
			for(var i=0; i<iidsObj.length; i++){ 
				if(iidsObj[i].checked)
				{
					iids.push(iidsObj[i].value);	
				}
			}
			
			if(iids.length>0)
			{
				var val_iids=iids.join(",")		
			}
			else
			{
				layer.alert("请选择行业");
				return false	
			}
			
			//获取广告位置数组
			var alIds=[];
			var alIdsObj=$(".ad_area :input");
			for(var i=0; i<alIdsObj.length; i++){ 
				if(alIdsObj[i].checked)
				{
					alIds.push(alIdsObj[i].value);	
				}
			} 
			
			if(alIds.length>0)
			{
				var val_alIds=alIds.join(",")		
			}
			else
			{
				layer.alert("请选择广告位");
				return false	
			}
			
			//获取投放时间
			if(val.choice_time_rdo==1)
			{
				var startTime=val.startTime;
				var endTime=val.endTime;	
			
				if(startTime>=endTime)
				{
					layer.alert("开始时间不能大于和等于结束时间");
					return false	
				}
			}
			else
			{
				var startTime=0;
				var endTime=0;	
			}
			
			
			//获取大区数组
			var aIds=[];
			var aIdsObj=$("#check_list :input");
			for(var i=0; i<aIdsObj.length; i++){ 
				if(aIdsObj[i].checked)
				{
					aIds.push(aIdsObj[i].value);	
				}
			} 
			if(aIds.length>0)
			{
				var val_aIds=aIds.join(",")		
			}
			else
			{
				layer.alert("请选择大区");
				return false	
			}
			
			//获取门店数组
			var sIds=[];
			var sIdsObj=$("#choice_shop_list :input");
			for(var i=0; i<sIdsObj.length; i++){ 
					sIds.push(sIdsObj[i].value);	
			} 
			if(sIds.length>0)
			{
				var val_sIds=sIds.join(",")		
			}
			else
			{
				layer.alert("请选择门店");
				return false	
			}
			
			//console.log(val_aIds);
			
			$.ajax({
				type : 'POST',
				url  : url,
				data : {'bpName':val.bpName, 'iids':val_iids, 'startDate':get_time(val.startDate), 'endDate':get_time(val.endDate), 'startTime':val.startTime, 'endTime':endTime, 'repeatType':val.repeatType, 'chargeType':val.chargeType, 'alIds':val_alIds, 'aIds':val_aIds, 'sIds':val_sIds,'basePrice':val.basePrice, 'incRange':val.incRange},
				dataType : 'json',
				success : function(data) {
					if(data.errCode == 0) {
						layer.msg("添加成功");
						location.reload();
					} else {
						layer.alert(data.errMsg);
					}
				},
				error : function(data) {
					layer.alert('添加异常');
				}
			});
			
		 	 return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
		});
	});
	
	//获取id编程模块
	var id=getUrlParam("schedule_id");
	if(id!='')
	{
		get_edit_info(id);
	}
});

//根据档期id获取信息
function get_edit_info(id)
{
	url=yonghui.contextPath+'/api/bidplan/findById.jsp';

	$.ajax({
		type : 'POST',
		url  : url,
		data : {bpId:id},
		dataType : 'json',
		success : function(data) {
			if(data.errCode==0)
			{
				var info=data.obj;
				$('#bpName').val(info.bpName);
				
				//获取默认行业
				var indarr=info.iids.split(',');
				for(var i=0;i<indarr.length;i++)
				{
					$('#industry_txt_'+indarr[i]).prop('checked',true);
				}
				
				//获取投放日期
				$("#startDate").val(laydate.now(info.startDate, 'YYYY-MM-DD'));
				$("#endDate").val(laydate.now(info.endDate, 'YYYY-MM-DD'));
				
				//获取投放时间
				if (info.startTime!=0 && info.endTime!=0)
				{
					$("#add-time").find("input[value=1]").prop("checked",true);
					$("#div_choice_time").show();
					$("#startTime").val(info.startTime);
					$("#endTime").val(info.endTime);
				}
				else
				{
					$("#add-time").find("input[value=0]").prop("checked",true);
				}
				
				//获取重复选择
				$("#add-repeat").find('input[value='+info.repeatedType+']').prop("checked",true);
				
				//获取广告位置
				var areaarr=info.alIds.split(',');
				for(var i=0;i<areaarr.length;i++)
				{
					$('#area_txt_'+areaarr[i]).prop('checked',true);
				}
				
				//获取投放地区
				var rginfo=get_region_shops(id);
				console.log(rginfo);
				
				var areaCodesarr=info.areaCodes.split(',');
				for(var i=0;i<areaCodesarr.length;i++)
				{
					$('#regional_box_'+areaCodesarr[i]).prop('checked',true);
				}
				$("#choice_shop_icon").show();
				$("#div_choice_shop").show();
				
				//获取投放门店
				
				//获取竞拍底价
				$("#basePrice").val(info.cbasePrice);
				var areaCodesarr=info.areaCodes.split(',');
				for(var i=0;i<areaCodesarr.length;i++)
				{
					$('#regional_box_'+areaCodesarr[i]).prop('checked',true);
				}
				
				//获取竞拍加价幅度
				$("#incRange").val(info.cincRange);
			}
			else
			{
				layer.alert(data.errMsg);
			}
		},
		error : function(data) {
			layer.alert('查询异常');
		}
	});
}

//根据档期ID获取大区门店
function get_region_shops(id)
{
	url=yonghui.contextPath+'/api/bidplan/query.jsp';
	
	$.post(url,{op:1,bpId:id},function(data){
		if(data.errCode==0)
		{
			var info=data.obj;
			console.log(info)
			
		}
		else
		{
			layer.alert(data.errMsg);
		}
	})
}

/**
 * [获取url参数值]
 * @param  name [参数名称]
 * @return [参数值]
 */
function getUrlParam(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"),
        r = window.location.search.substr(1).match(reg);
    return null != r ? unescape(r[2]) : null;
}
    
//门店批量选择
function choice_right()
{
	var htm='';
	
	var shop_dom=$('.shops_box');
	var code=shop_dom.attr('area_code');
	shop_dom.each(function(){
		if($(this).is(":checked"))
		{
			if(!$('#choice_shop_list').find('tr[id=tr_choice_shops_'+$(this).val()+']').length)
			{
				htm +='<tr id="tr_choice_shops_'+$(this).val()+'">'
				htm +='<td><input name="choice_shops" class="choice_shops_box" value="'+$(this).val()+'" title="'+$(this).attr('title')+'" type="checkbox" lay-filter="check_choice_shops"></td>'									
				htm +='</tr>';
			}
			$(this).attr('disabled',true);
		}
	})
	
	//$("#regional_box_"+code).prop('checked',false);
	var choice_shop_dom=$('.choice_shops_box').find('input');
	
	$('#choice_shop_list').append(htm);
	form.render('checkbox');
}

//门店批量取消
function choice_left()
{
	var shop_dom=$('.choice_shops_box');
	shop_dom.each(function(){
		if($(this).is(":checked"))
		{
			$("#tr_choice_shops_"+$(this).val()).remove();
			$("#shops_box_"+$(this).val()).prop("checked",false);
		}
	})
	
	form.render('checkbox');
}

//根据大区获取门店
function get_shops(code)
{
	url=yonghui.contextPath + '/api/common/getBaseShopsByAreaCodes.jsp';
	
	$.post(url,{areaCodes:code},function(data){
		var htm='';
		
		if(data.errCode==0)
		{
			var val=data.obj;
			
			if(val.length>0)
			{
					
				$("#shops_list_icon").show();
				$("#shops_list").show();
				$("#choice_shop_icon").show();
				$("#div_choice_shop").show();
				
				for(var i=0;i<val.length;i++)
				{
					htm +='<tr><td>';
					
					htm +='<input id="shops_box_'+val[i].shopCode+'" area_code="'+code+'" class="shops_box" value="'+val[i].shopCode+'" title="'+val[i].shopName+'" type="checkbox" lay-filter="check_shops">'
				
					htm +='</td></tr>';
				}
				
				$('#show_shops_list').html(htm);
				form.render('checkbox');
			}		
		}
		else
		{
			layer.alert(data.errMsg);	
		}
	})		
}

//获取大区
function get_regional()
{
	url=yonghui.contextPath + '/api/common/getAllArea.jsp';
	
	$.post(url,function(data){
		var htm='';
		
		if(data.errCode==0)
		{
			var val=data.obj;
			
				htm +='<tr><td>';
				
				htm +='<input name="region" title="全选" value="-1"  type="checkbox" lay-filter="check_region" >'
				
				htm +='</td></tr>';
							
			for(var i=0;i<val.length;i++)
			{
				htm +='<tr><td>';
				
				htm +='<input id="regional_box_'+val[i].areaCode+'" class="regional_box" name="region" value="'+val[i].areaCode+'" title="'+val[i].areaName+'" type="checkbox" lay-filter="check_region">'
			
				htm +='</td></tr>';
			}
			
			
			$('#check_list').html(htm);
		}
		else
		{
			layer.alert(data.errMsg);	
		}
	})	
}

//获取行业信息
function get_industry()
{
	url=yonghui.contextPath + '/api/common/getAllIndustry.jsp';
	
	$.post(url,function(data){
		var htm='';
		
		if(data.errCode==0)
		{
			var val=data.obj;
			
			for(var i=0;i<val.length;i++)
			{
				if(i==0)
				{
					htm +='<input id="industry_txt_'+val[i].iid+'" value="'+val[i].iid+'" title="'+val[i].iname+'" type="checkbox" checked>';
				}
				else
				{
					htm +='<input id="industry_txt_'+val[i].iid+'" value="'+val[i].iid+'" title="'+val[i].iname+'" type="checkbox">';	
				}
			}
			
			$('.industry-type').html(htm);
		}
		else
		{
			layer.alert(data.errMsg);	
		}
	})
}

//获取广告位信息
function get_area()
{
	url=yonghui.contextPath + '/api/ad/adlocation/getAllBaseAdLocation.jsp';
	
	$.post(url,function(data){
		var htm='';
		
		if(data.errCode==0)
		{
			var val=data.obj;
			
			for(var i=0;i<val.length;i++)
			{
				htm +='<input id="area_txt_'+val[i].first+'" value="'+val[i].first+'" title="'+val[i].second+'" type="checkbox">';
			}
			
			$('.ad_area').html(htm);
		}
		else
		{
			layer.alert(data.errMsg);	
		}
	})		
}

//时间转换为时间戳  毫秒
function get_time(time)
{
	return Date.parse(new Date(time));
}