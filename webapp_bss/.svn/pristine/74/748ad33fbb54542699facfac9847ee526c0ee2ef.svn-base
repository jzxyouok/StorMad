$(function() {
	
	//初始化数据模块
	get_industry();
	get_area();
	get_regional();
	
	//表达验证与提交
	layui.use('form', function(){
		var form = layui.form();

		//监听大区选择
		form.on('radio(check_region)', function(data){
		  	if(data.value==-1)
			{
				$("#shops_list_icon").hide();
				$("#shops_list").hide();
			}
			else
			{
				get_shops(data.value)	
			}
			
			form.render('checkbox')
		}); 
		
		//监听大区选择
		form.on('radio(check_region_rdo)', function(data){
				get_shops(data.value);
		});
		
		form.on('radio(choice_time)', function(data){
				if(data.value==1)
				{
					$("#div_choice_time").show();
					$("#startTime").attr('lay-verify','required');
					$("#endTime").attr('lay-verify','required');
				}
				else
				{
					$("#div_choice_time").hide();
					$("#startTime").removeAttr('lay-verify');
					$("#endTime").removeAttr('lay-verify');
				}
		}); 


		//更新渲染
		form.render('select');
		form.render('checkbox');
		
		//提交新增表单
		form.on('submit(sub)', function(data){
			var val=data.field;
			var url=yonghui.contextPath + '/api/bidplan/create.jsp';
			
			//获取行业数组
			var iids=[];
			var iidsObj=$(".industry-type :input");
			for(var i=0; i<iidsObj.length; i++){ 
				if(iidsObj[i].checked)
				{
					iids.push(iidsObj[i].value);	
				}
			}
			
			if(iids.length>0)
			{
				var val_iids=iids.join(",")		
			}
			else
			{
				layer.alert("请选择行业");
				return false	
			}
			
			//获取广告位置数组
			var alIds=[];
			var alIdsObj=$(".ad_area :input");
			for(var i=0; i<alIdsObj.length; i++){ 
				if(alIdsObj[i].checked)
				{
					alIds.push(alIdsObj[i].value);	
				}
			} 
			
			if(alIds.length>0)
			{
				var val_alIds=alIds.join(",")		
			}
			else
			{
				layer.alert("请选择广告位");
				return false	
			}
			
			//获取投放时间
			if(val.choice_time_rdo==1)
			{
				var startTime=val.startTime;
				var endTime=val.endTime;	
			
				if(startTime>=endTime)
				{
					layer.alert("开始时间不能大于和等于结束时间");
					return false	
				}
			}
			else
			{
				var startTime=0;
				var endTime=0;	
			}

			$.ajax({
				type : 'POST',
				url  : url,
				data : {'bpName':val.bpName, 'iids':val_iids, 'startDate':get_time(val.startDate), 'endDate':get_time(val.endDate), 'startTime':val.startTime, 'endTime':endTime, 'repeatType':val.repeatType, 'chargeType':val.chargeType, 'alIds':val_alIds, 'aIds':'110000,120000', 'sIds':'9080,9081,9007,9009','basePrice':val.basePrice, 'incRange':val.incRange},
				dataType : 'json',
				success : function(data) {
					if(data.errCode == 0) {
						layer.msg("添加成功");
						location.reload();
					} else {
						layer.alert(data.errMsg);
					}
				},
				error : function(data) {
					layer.alert('添加异常');
				}
			});
			
		 	 return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
		});
		
	});

});

//根据大区获取门店
function get_shops(code)
{
	url=yonghui.contextPath + '/api/common/getBaseShopsByAreaCodes.jsp';
	
	$.post(url,{areaCodes:code},function(data){
		var htm='';
		
		if(data.errCode==0)
		{
			var val=data.obj;
			
			if(val.length>0)
			{
					
				$("#shops_list_icon").show();
				$("#shops_list").show();
			
				for(var i=0;i<val.length;i++)
				{
					htm +='<tr><td>';
					
					htm +='<input value="'+val[i].shopCode+'" title="'+val[i].shopName+'" type="checkbox" >';
				
					htm +='</td></tr>';
				}
	
				$('#show_shops_list').html(htm);
			}		
		}
		else
		{
			layer.alert(data.errMsg);	
		}
	})		
}

//获取大区
function get_regional()
{
	url=yonghui.contextPath + '/api/common/getAllArea.jsp';
	
	$.post(url,function(data){
		var htm='';
		
		if(data.errCode==0)
		{
			var val=data.obj;
			
				htm +='<tr><td>';
				
				htm +='<input name="region" title="全选" value="-1"  type="radio" lay-filter="check_region" >'
				
				htm +='</td></tr>';
							
			for(var i=0;i<val.length;i++)
			{
				htm +='<tr><td>';
				
				htm +='<input name="region" value="'+val[i].areaCode+'" title="'+val[i].areaName+'" type="radio" lay-filter="check_region">'
			
				htm +='</td></tr>';
			}

			$('#check_list').html(htm);
		}
		else
		{
			layer.alert(data.errMsg);	
		}
	})	
}

//获取行业信息
function get_industry()
{
	url=yonghui.contextPath + '/api/common/getAllIndustry.jsp';
	
	$.post(url,function(data){
		var htm='';
		
		if(data.errCode==0)
		{
			var val=data.obj;
			
			for(var i=0;i<val.length;i++)
			{
				if(i==0)
				{
					htm +='<input value="'+val[i].iid+'" title="'+val[i].iname+'" type="checkbox" checked>';
				}
				else
				{
					htm +='<input value="'+val[i].iid+'" title="'+val[i].iname+'" type="checkbox">';	
				}
			}
			
			$('.industry-type').html(htm);
		}
		else
		{
			layer.alert(data.errMsg);	
		}
	})
}

//获取广告位信息
function get_area()
{
	url=yonghui.contextPath + '/api/ad/adlocation/getAllBaseAdLocation.jsp';
	
	$.post(url,function(data){
		var htm='';
		
		if(data.errCode==0)
		{
			var val=data.obj;
			
			for(var i=0;i<val.length;i++)
			{
				htm +='<input value="'+val[i].first+'" title="'+val[i].second+'" type="checkbox">';
			}
			
			$('.ad_area').html(htm);
		}
		else
		{
			layer.alert(data.errMsg);	
		}
	})		
}

//时间转换为时间戳  毫秒
function get_time(time)
{
	return Date.parse(new Date(time));
}