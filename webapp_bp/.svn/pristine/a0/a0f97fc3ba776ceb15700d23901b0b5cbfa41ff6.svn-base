$(function() {

    //初始化
    var pageNo = 1;
    var content = "";
    var opTime = "";

    var reportDate = "";
    var bpName = "";
    var iName = "";
    var adTitle = "";

    var reportDateArr = [];
    var clickRateArr = [];


    /*明细参数*/
    var bpId, iId, alId, adId,bpId0, iId0, alId0, adId0;

    list(pageNo, content, opTime);

    //表达验证与提交
    layui.use('form', function() {
        var form = layui.form();

        //搜索表单提交
        form.on('submit(search)', function(data) {
            var val = data.field;

            var opTime = "";

            list(1, val.content, val.opTime)

            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });
    });
    dataDetail();
    // getDetailFirst();
    $('.show_info').on('click','.btn-radio',function(){
        console.log('111');
    });
    // getDetailFirst();
});

function dataDetail() {
    $('.show_info').on('click', 'button.data-Detail', function() {
        var detail = layer.open({
            type: 1,
            area: ['900px', 'auto'],
            title: ['广告投放明细', 'color:#666;font-size:14px;font-weight:bold;'], //自定义标题
            shadeClose: true, //点击遮罩关闭
            content: $('#dataDetail')
        });
        $('.btn-know').on('click', function() {
            parent.layer.close(detail);
        });
        bpId = $(this).attr('data-bpId');
        iId = $(this).attr('data-iId');
        alId = $(this).attr('data-alId');
        adId = $(this).attr('data-adId');

        getDetail(bpId,iId,alId,adId);
    });

}
var reportDateArr=[];
var clickRateArr=[];
/*初始化报表展示*/
function getDetailFirst() {
    console.log(bpId0);
    $.ajax({
        type: 'POST',
        url: yonghui.contextPath + '/api/report/getAdReportDetail.jsp',
        data: { 'bpId': bpId0, 'iId': iId0, 'alId': alId0, 'adId': adId0 },
        dataType: 'json',
        success: function(data) {
            if (data.errCode == 0) {
                var val = data.obj;
                var htm = '';
                var bpStartTime, bpEndTime;
                if (val.datas.length > 0) {
                    for (var i = 0; i < val.datas.length; i++) {
                        reportDateArr.push(val.datas[i].reportDate);
                        clickRateArr.push(val.datas[i].clickRate);
                    }
                    $('#detail_info').html(htm);
                    showCharts(data);
                    console.log(reportDateArr);
                    console.log(clickRateArr);
                    
                }

            }
            if (data.errCode == -10000) {
                layer.open({
                    skin: 'loginTip',
                    content: '您尚未登录系统，不能进行操作！',
                    btn: '我知道了',
                    yes: function(index, layero) {
                        window.location.href = '../../ader/login.html';
                    },
                    cancel: function() {
                        window.location.href = '../../ader/login.html';
                    }
                })
            }
        },
        error: function(data) {
            console.log("失败");
        }
    });
}
/*查看明细*/
function getDetail() {
    $.ajax({
        type: 'POST',
        url: yonghui.contextPath + '/api/report/getAdReportDetail.jsp',
        data: { 'bpId': bpId, 'iId': iId, 'alId': alId, 'adId': adId },
        dataType: 'json',
        success: function(data) {
            if (data.errCode == 0) {
                var val = data.obj;
                var htm = '';
                var bpStartTime, bpEndTime;
                if (val.datas.length > 0) {
                    for (var i = 0; i < val.datas.length; i++) {
                        bpStartTime = new Date(Number(val.bpStartTime));
                        bpStartTime = bpStartTime.format('yyyy-MM-dd');
                        bpEndTime = new Date(Number(val.bpEndTime));
                        bpEndTime = bpEndTime.format('yyyy-MM-dd');

                        reportDateArr.push(val.datas[i].reportDate);
                        clickRateArr.push(val.datas[i].clickRate);

                        

                        htm += '<tr>';
                        htm += '<td>' + bpStartTime + '至' + bpEndTime + '</td><td>' + val.adTitle + '</td><td>' + val.datas[i].eprCount + '</td><td>' + val.datas[i].clickCount + '</td><td>' + val.datas[i].clickRate + '%' + '</td>'
                    }
                    $('#detail_info').html(htm);
                    showCharts(data);
                    console.log(reportDateArr);
                    console.log(clickRateArr);
                    
                }

            }
            if (data.errCode == -10000) {
                layer.open({
                    skin: 'loginTip',
                    content: '您尚未登录系统，不能进行操作！',
                    btn: '我知道了',
                    yes: function(index, layero) {
                        window.location.href = '../../ader/login.html';
                    },
                    cancel: function() {
                        window.location.href = '../../ader/login.html';
                    }
                })
            }
        },
        error: function(data) {
            console.log("失败");
        }
    });
}

function list(pageNo, content, opTime) {
    //分页模块
    layui.use('laypage', function() {
        var laypage = layui.laypage
        var req = { pageNo: pageNo, pageSize: yonghui.pageSize, content: content, opTime: opTime };
        //初始化分页参数
        $.post(yonghui.contextPath + "/api/report/findAdReportPage.jsp", req, function(data) {

            if (data.errCode == 0) {
                val = data.obj;

                laypage({
                    cont: 'pageNumber',
                    groups: yonghui.groups,
                    pages: val.pageCount,
                    skip: true,
                    jump: function(obj, first) {
                        if (first) {
                            get_info(data);
                        } else {
                            query(obj.curr);
                        }
                    }
                });
            } else if (data.errCode == -10000) {
                layer.open({
                    skin: 'loginTip',
                    content: '您尚未登录系统，不能进行操作！',
                    btn: '我知道了',
                    yes: function(index, layero) {
                        window.location.href = '../../ader/login.html';
                    },
                    cancel: function() {
                        window.location.href = '../../ader/login.html';
                    }
                })
            } else {
                layer.alert(data.errMsg)
            }
        });
    });
}

function get_info(data) {
    layui.use('laydate', function() {
        var laydate = layui.laydate;

        var val = data.obj.record;

        var htm = "";

        if (val.length > 0) {

            for (var i = 0; i < val.length; i++) {
                /*时间戳格式转换*/
                var bpStartTime = new Date(Number(val[i].bpStartTime));
                bpStartTime = bpStartTime.format('yyyy-MM-dd');
                var bpEndTime = new Date(Number(val[i].bpEndTime));
                bpEndTime = bpEndTime.format('yyyy-MM-dd');

                bpId0=val[0].bpId;
                iId0=val[0].iId;
                alId0=val[0].alId;
                adId0=val[0].adId;

                htm += '<tr>';

                htm += '<td> <div class="checkbox"> <label class="btn-radio" data-bpId=' + val[i].bpId + ' data-iId=' + val[i].iid + ' data-alId=' + val[i].alId + ' data-adId=' + val[i].adId + '> <span class="checkbox"><input name="btnSelect" id="" type="radio"><i></i> </span> </label> </div> </td>';

                htm += '<td>' + val[i].bpName + '</td><td>' + bpStartTime + '至 <span id="today">' + bpEndTime + '</span></td><td>' + val[i].iname + '</td><td>' + val[i].alName + '</td><td>' + val[i].adTitle + '</td><td>' + val[i].eprCount + '</td><td>' + val[i].clickCount + '</td><td>' + val[i].clickRate + '%' + '</td><td><button type="button" class="btn btn-default data-Detail" data-bpId=' + val[i].bpId + ' data-iId=' + val[i].iid + ' data-alId=' + val[i].alId + ' data-adId=' + val[i].adId + '>查看明细</button></td>';

                htm += '</tr>';
            }

            $("#log_info").html(htm);
            $('')
            $(".no_info").hide();
            $(".show_info").show();
        } else {
            $(".no_info").show();
            $(".show_info").hide();
        }
    });
}


function query(pageNo, opTime, content) {
    var curopTime = $('.btn-opTime').val();
    var curContent = $('.btn-content').val();
    var req = { pageNo: pageNo, pageSize: yonghui.pageSize, opTime: curopTime, content: curContent };
    $.post(yonghui.contextPath + "/api/report/findAdReportPage.jsp", req, function(data) {
        if (data.errCode == 0) {
            get_info(data);
        } else {
            layer.alert('查询列表失败!\r\n' + data.errMsg);
        }
    });
};

/*报表展示*/
function showCharts(data) {
    Highcharts.setOptions({
        colors: ['#705758']
    });
    $('#container').highcharts({
        /*chart: {
            borderColor: '#e6614f',
            borderWidth: 4,
            type: 'line'
        },*/
        title: {
            text: '广告投放效果趋势图',
            align: 'left',
            style: {
                color: '#664545',
                fontWeight: 'bold',
                fontSize: 14
            },
            verticalAlign: 'top',
            x: 20,
            y: 10
        },
        /*subtitle: {
            text: '纵轴：（点击率/展现量）   横轴：日期',
            align: 'left',
            style: {
                color: '#e6614f',
                fontSize: 12
            },
            verticalAlign: 'top',
            x: 180,
            y: 10
        },*/
        xAxis: {
            title: {
                text: '日期',
            },
            labels: {
                align: 'center'
            },
            categories: reportDateArr
        },
        yAxis: {
            title: {
                text: '点击率（%）',
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {
            backgroundColor: '#e6614f',
            borderColor: '#c74545',
            borderRadius: 3,
            valueSuffix: '%',
            shadow: false,
            style: {
                color: '#fff',
                fontSize: '12px',
                padding: '8px'
            }
        },
        legend: {
            style: {
                color: '#664545',
                fontSize: 14
            },
            layout: 'vertical',
            align: 'center',
            verticalAlign: 'top',
            x: 0,
            y: -10
        },
        series: [{
            name: '点击率',
            data: clickRateArr
        }]
    });
}
