/**
 * 
 */				
$(function() {
	var queryGroups=function(pageNo) {
		$.ajax({
			type : 'POST',
			url  : yonghui.contextPath + '/api/ad/spread/findSpreadGroupPage.jsp',
			data : {'pageNo':pageNo, 'pageSize':yonghui.pageSize},
			dataType : 'json',
			success : function(data) {
				if(data.errCode == 0) {
					fillTable(data.obj);
				} else {
					layer.alert('查询推广组失败!\r\n' + data.errMsg);
				}
			},
			error :function(data) {
				layer.alert('查询推广组失败!\r\n' + data.errMsg);
			}
		});
	};
	
	//填充表格
	var fillTable=function(page) {
		var tbl = '';
		var statusCN = '';
		var list = page.record;
		
		var spreadPlan = '';
		$('#tblGroup tbody').html('');
		for(var i = 0; i < list.length; i++) {
			if(list[i].spreadPlan == null) {
				spreadPlan = '';
			} else {
				spreadPlan = list[i].spreadPlan.spName;
			}

			tbl += '<tr>';
			tbl += '<td><div class="checkbox"><label><span class="checkbox">';
			tbl += '<input name="sgId" id="'+list[i].sgId+'" value="'+list[i].sgId+'" type="checkbox"><i></i>';
			tbl += '</span></label></div></td>';
			tbl += '<td>'+ list[i].sgName +'</td>';
			tbl += '<td>'+ list[i].pv +'</td>';
			tbl += '<td>'+ list[i].click +'</td>';
			tbl += '<td>'+ list[i].ctr +'</td>';
			tbl += '<td>'+ spreadPlan +'</td>';
			tbl += '<td>'+ list[i].adCount +'</td>';
			statusCN = '推广中';
			if(list[i].sgStatus == 0) {
				statusCN = '未参与';
			}
			tbl += '<td>'+ statusCN +'</td>';
			tbl += '<td><a class="edit-Plan" href="javascript:editGroup(\''+ list[i].sgId +'\', \''+ list[i].sgName +'\');">编辑</a>';
			tbl += '<a class="plan-Delete" href="javascript:delGroup(\''+ list[i].sgId +'\');">删除</a></td>';
			tbl += '</tr>';
		}
		$("#tblGroup tbody").html(tbl);
	};
	
	layui.use(['laypage', 'layer'], function(){
		var laypage = layui.laypage, layer = layui.layer;
		var page = null;
		
		$.ajax({
			type : 'POST',
			url  : yonghui.contextPath + '/api/ad/spread/findSpreadGroupPage.jsp',
			data : {'pageNo':1, 'pageSize':yonghui.pageSize},
			dataType : 'json',
			success : function(data) {
				if(data.errCode == 0) {
					page = data.obj;
					laypage({
						cont: 'pageNumber',
						groups: yonghui.groups,
						pages: page.pageCount,
						jump: function(obj, first){
							if(first) {
								fillTable(page);
							} else {
								queryGroups(obj.curr);
							}
						}
					});
				} else {
					layer.alert('查询推广组失败\r\n' + data.errMsg);
				}
			},
			error :function(data) {
				layer.alert('查询推广组失败!\r\n' + data.errMsg);
			}
		});
	});
	
	//查询推广计划
	var queryPlans=function(pageNo, pageSize) {
		$.ajax({
			type : 'POST',
			url  : yonghui.contextPath + '/api/ad/spread/findSpreadPlanPage.jsp',
			data : {'pageNo':pageNo, 'pageSize':pageSize},
			dataType : 'json',
			success : function(data) {
				if(data.errCode == 0) {
					fillPlans(data.obj.record);
				} else {
					layer.alert('查询推广计划失败!\r\n' + data.errMsg);
				}
			},
			error :function(data) {
				layer.alert('查询推广计划失败!\r\n' + data.errMsg);
			}
		});
	};
	
	//填充推广计划下拉框
	var fillPlans=function(list) {
		var options = '';
		if(list != null) {
			for(var i = 0; i < list.length; i++) {
				options += '<option value=\''+ list[i].spId + '\'>'+ list[i].spName +'</option>';
			}
			$('#plans').append(options);
		}
	}
	
	//完成元素的渲染和事件的监听
	layui.use('form', function(){
		var form = layui.form();
  
		$.ajax({
			type : 'POST',
			url  : yonghui.contextPath + '/api/ad/spread/findSpreadPlanPage.jsp',
			data : {'pageNo':1, 'pageSize':100},
			dataType : 'json',
			success : function(data) {
				if(data.errCode == 0) {
					var list = data.obj.record;
					var options = '';
					for(var i = 0; i < list.length; i++) {
						options += '<option value=\''+ list[i].spId + '\'>'+ list[i].spName +'</option>';
					}
					$('#plans').append(options);
					form.render('select');
				} else {
					layer.alert('查询推广计划失败!\r\n' + data.errMsg);
				}
			},
			error :function(data) {
				layer.alert('查询推广计划失败!\r\n' + data.errMsg);
			}
		});
	});
	
	//添加推广组
	$("#btnSave").click(function() {
		var groupId = $('#groupId').val();
		if(groupId == '') {
			addGroup();
		} else {
			updateGroup();
		}
	});
	
	//新增推广组
	var addGroup=function() {
		var groupName = $('#groupName').val();
		if(groupName == '') {
			layer.alert('请输入推广组名称');
			$('#groupName').focus();
			return;
		}
		var planId = $('#plans').val();
		
		alert('groupName['+groupName+'] planId['+planId+']');
		
		$.ajax({
			type : 'POST',
			url  : yonghui.contextPath + '/api/ad/spread/addSpreadGroup.jsp',
			data : {'sgName':groupName, 'spId': planId},
			dataType : 'json',
			success : function(data) {
				if(data.errCode == -10000) {
					layer.alert('你尚未登录系统，不能操作');
					return;
				}
				if(data.errCode != 0) {
					layer.alert('新增推广组失败，错误原因['+data.errMsg+']');
					return;
				}
				layer.msg('新增推广组成功');
				layer.closeAll('page');	
				queryGroups(1);
			},
			error :function(data) {
				layer.alert('新增推广组失败!\r\n' + data.errMsg);
			}
		});
	};
	
	//更新推广组
	var updateGroup=function() {
		var groupName = $('#groupName').val();
		var groupId = $('#groupId').val();
		
		if(groupName == '') {
			layer.alert('请输入推广组名称');
			$('#groupName').focus();
			return;
		}
		if(groupId == '') {
			layer.alert('未指定修改推广组的ID');
			return;
		}
		
		alert('Name['+groupName+']  ID['+groupId+']');
		
		$.ajax({
			type : 'POST',
			url  : yonghui.contextPath + '/api/ad/spread/updateSpreadGroup.jsp',
			data : {'sgName':groupName, 'sgId':groupId},
			dataType : 'json',
			success : function(data) {
				if(data.errCode == -10000) {
					layer.alert('你尚未登录系统，不能操作');
					return;
				}
				if(data.errCode != 0) {
					layer.alert(data.errMsg);
					return;
				}
				$('#groupId').val('');
				layer.msg('更新推广组成功');
				layer.closeAll('page');	
				queryGroups(1);
			},
			error :function(data) {
				layer.alert('编辑推广组失败!\r\n' + data.errMsg);
			}
		});
	};
	
	//暂停推广组
	$('#stop_group').click(function() {
		var sgId = '';
		var count = 0;
		$('input[name="sgId"]').each(function(){
			if( $(this).get(0).checked) {
				sgId = $(this).attr('value');
				count++;
			}
		});
		
		if(count == 0) {
			layer.msg('请选中一个推广组暂停');
			return;
		}
		if(count > 1) {
			layer.msg('只能选择一个推广组暂停');
			return;
		}
		updateGroupStatus(sgId, 0);
	});
	
	//参与推广组
	$('#join_plan').click(function() {
		var sgId = null;
		var count = 0;
		
		$('input[name="sgId"]').each(function(){
			if( $(this).get(0).checked) {
				sgId = $(this).attr('value');
				count++;
			}
		});
		
		if(count == 0) {
			layer.msg('请选中一个组参与推广');
			return;
		}
		if(count > 1) {
			layer.msg('只能选择一个组参与推广');
			return;
		}
		
		updateGroupStatus(sgId, 1);
	});
	
	//执行推广组状态更新
	var updateGroupStatus=function(groupId, status) {
		$.ajax({
			type : 'POST',
			url  : yonghui.contextPath + '/api/ad/spread/updateSgStatus.jsp',
			data : {'sgStatus':status, 'sgId':groupId},
			dataType : 'json',
			success : function(data) {
				if(data.errCode == -10000) {
					layer.alert('你尚未登录系统，不能操作');
					return;
				}
				if(data.errCode != 0) {
					layer.alert(data.errMsg);
					return;
				}
				layer.alert("更新推广组状态成功");
				layer.closeAll('page');
				queryGroups(1);
			},
			error :function(data) {
				layer.alert('编辑推广组失败!\r\n' + data.errMsg);
			}
		});
	};
});

//弹出新增和修改广告组窗口
var editGroup=function(id, name) {
	$('#groupName').val(name);
	$('#groupId').val(id);
	
	layer.open({
        type: 1,
        area: ['580px', 'auto'],
        //offset: 'rb', //弹窗右下角
        title: false, //隐藏默认标题
        title: ['推广组编辑', 'color:#666;font-size:14px;font-weight:bold;'], //自定义标题
        shadeClose: true, //点击遮罩关闭
        content: $('#editGroup')
    });
	
	//完成元素的渲染和事件的监听
	layui.use('form', function(){
		var form = layui.form();
  
		//如果是编辑，屏蔽推广计划
		if(id != '') {
			$('.layui-form').prev().css('display', 'none');
			$('.layui-form').css('display', 'none');
			form.render('');
		} else {
			$('.layui-form').prev().css('display', 'block');
			$('.layui-form').css('display', 'block');
			form.render('');
		}
	});
};

var delGroup=function(id) {
	layer.msg('删除广告组['+id+']');
};